library(Seurat)
library(SCopeLoomR)
library(dplyr)
library(ggplot2)
library(ggrepel)
library(cowplot)
library(SCENIC)
library(AUCell)
library(BiocParallel)

register(MulticoreParam(workers = 4, progressbar = TRUE))
# loom
scRNA <- readRDS("/data/RDS/Annotation/10_PBMC_annotation_L3.rds")
raw_counts <- GetAssayData(scRNA, assay = "RNA", slot = "counts")
genes_over_threshold <- Matrix::rowSums(raw_counts) > (ncol(raw_counts) * 0.03)
genes_expressed_in_cells <- Matrix::rowSums(raw_counts > 0) > (ncol(raw_counts) * 0.01)
keep_genes <- genes_over_threshold & genes_expressed_in_cells
expr_filtered <- raw_counts[keep_genes, ]
loom_file <- "/data/SCENIC/PBMC_Mcell.loom"
loom <- build_loom(file.name = loom_file, dgem = expr_filtered)
loom$close()

#=====================
# pySCENIC
#=====================
# GRN
# pyscenic grn --seed 777 --num_workers 20 \
#              --output /data/SCENIC/PBMC_adj.tsv \
#              --method grnboost2 \
#              /data/SCENIC/PBMC_Mcell.loom \
#              /data/SCENIC/file/allTFs_hg38.txt

# Motif Enrichment
# pyscenic ctx /data/SCENIC/PBMC_adj.tsv \
#              /data/SCENIC/file/hg38_500bp_up_100bp_down_full_tx_v10_clust.genes_vs_motifs.rankings.feather \
#              /data/SCENIC/file/hg38_10kbp_up_10kbp_down_full_tx_v10_clust.genes_vs_motifs.rankings.feather \
#              --annotations_fname /data/SCENIC/file/motifs-v10nr_clust-nr.hgnc-m0.001-o0.0.tbl \
#              --expression_mtx_fname /data/SCENIC/PBMC_Mcell.loom \
#              --output /data/SCENIC/PBMC_step2out_ctx.tsv \
#              --mode "dask_multiprocessing" --num_workers 20 --mask_dropouts

# AUC
# pyscenic aucell /data/SCENIC/PBMC_Mcell.loom \
#                 /data/SCENIC/PBMC_step2out_ctx.tsv \
#                 --output /data/SCENIC/PBMC_out_SCENIC.loom \
#                 --num_workers 20


##=====================
#  SCENIC R analysis
library(Seurat)
library(SCopeLoomR)
library(AUCell)
library(SCENIC)
library(dplyr)
library(ggplot2)
library(ggrepel)
library(cowplot)
library(BiocParallel)
register(MulticoreParam(workers = 4, progressbar = TRUE))
#=====================
# 1️ CTL Group compare
loom <- open_loom("/data/SCENIC/PBMC_out_SCENIC.loom")
sce <- readRDS("/data/RDS/CTL.rds")

#data prepare
regulons_incidMat <- get_regulons(loom, column.attr.name = "Regulons")
regulons_incidMat[1:4, 1:4]
regulons <- regulonsToGeneLists(regulons_incidMat)
class(regulons)
regulonAUC <- get_regulons_AUC(loom, column.attr.name = 'RegulonsAUC')
regulonAucThresholds <- get_regulon_thresholds(loom)
tail(regulonAucThresholds[order(as.numeric(names(regulonAucThresholds)))])

#match seurat_regulon
common_cells <- intersect(colnames(regulonAUC), colnames(sce))
sce <- sce[, common_cells]
sub_regulonAUC <- regulonAUC[, common_cells]
dim(sub_regulonAUC)
dim(sce)
identical(colnames(sub_regulonAUC), colnames(sce))
Group <- data.frame(row.names = colnames(sce),
                    group = sce$group)
CellTypes <- data.frame(row.names = colnames(sce),
                        celltype = sce$L3_celltype)
Gender <- data.frame(row.names = colnames(sce),
                     gender = sce$gender)
save(
  sub_regulonAUC,
  CellTypes,
  Group,
  Gender,
  sce,
  file = "/data/SCENIC/CTL_SCENIC_for_rss_and_visual.Rdata"
)
#group_compare
table(sce$group)
selectedResolution <- "group"
cellsPerGroup <- split(rownames(Group), Group[, selectedResolution])
sub_regulonAUC <- sub_regulonAUC[onlyNonDuplicatedExtended(rownames(sub_regulonAUC)), ]
dim(sub_regulonAUC)
# Regulon Specificity Score, RSS
selectedResolution <- "group"
rss <- calcRSS(AUC = getAUC(sub_regulonAUC),
               cellAnnotation = Group[colnames(sub_regulonAUC),
                                      selectedResolution])
rss <- na.omit(rss)
B_rss <- as.data.frame(rss)
group <- c("YOUNG", "OLD")
rssRanklist <- list()
for (i in 1:length(group)) { # nolint
  data_rank_plot <- cbind(as.data.frame(rownames(B_rss)),
                          as.data.frame(B_rss[,group[i]]))
  colnames(data_rank_plot) <- c("TF", "group")
  data_rank_plot <- na.omit(data_rank_plot)
  data_rank_plot <- data_rank_plot[order(data_rank_plot$group, decreasing = TRUE), ]
  data_rank_plot_top10 <- data_rank_plot[1:10, ]
  data_rank_plot_top10$rank <- seq(1, 10)
  ## plot Figure 4F
  p <- ggplot(data_rank_plot_top10, aes(x = rank, y = group)) +
    geom_point(size = 3, color = "#1F77B4") +
    theme_bw() +
    theme(axis.title = element_text(colour = "black", size = 12),
          axis.text = element_text(colour = "black", size = 10),
          axis.text.x = element_blank(),
          axis.ticks.x = element_blank()) +
    labs(x = "Regulons Rank", y = "Specificity Score", title = group[i]) +
    geom_text_repel(aes(label = TF), color = "black", size = 3, fontface = "italic",
                    arrow = arrow(ends = "first", length = unit(0.01, "npc")),
                    box.padding = 0.2, point.padding = 0.3,
                    segment.color = "black", segment.size = 0.3,
                    force = 1, max.iter = 3e3)
  rssRanklist[[i]] <- p
}
combined_plot <- plot_grid(rssRanklist[[1]], rssRanklist[[2]],
                           nrow = 1, align = "h",
                           axis = "tb", rel_widths = c(1, 1))
combined_plot
ggsave("/data/Figure/F4F_CTL_YOUNG_OLD_RSS_top10.pdf", combined_plot,
       width = 6,
       height = 6,
       device = "pdf")
loom$close()
#=====================
# 2️ Tem celltype compare
#=====================
loom <- open_loom("/data/SCENIC/PBMC_out_SCENIC.loom")
sce <- readRDS("/data/RDS/Tem_01_02.rds")
# data prepare
regulons_incidMat <- get_regulons(loom, column.attr.name = "Regulons")
regulons <- regulonsToGeneLists(regulons_incidMat)
regulonAUC <- get_regulons_AUC(loom, column.attr.name = "RegulonsAUC")
regulonAucThresholds <- get_regulon_thresholds(loom)
tail(regulonAucThresholds[order(as.numeric(names(regulonAucThresholds)))])
# match seurat_regulon
common_cells <- intersect(colnames(regulonAUC), colnames(sce))
sce <- sce[, common_cells]
sub_regulonAUC <- regulonAUC[, common_cells]
identical(colnames(sub_regulonAUC), colnames(sce))

Group <- data.frame(row.names = colnames(sce),
                    group = sce$group)
CellTypes <- data.frame(row.names = colnames(sce),
                        celltype = sce$cell_type)
Gender <- data.frame(row.names = colnames(sce),
                     gender = sce$gender)
save(
  sub_regulonAUC,
  CellTypes,
  Group,
  Gender,
  sce,
  file = '/data/SCENIC/Tem_SCENIC_for_rss_and_visual.Rdata'
)
#celltype_compare
table(sce$cell_type)
selectedResolution <- "celltype"
cellsPerGroup <- split(rownames(CellTypes), CellTypes[, selectedResolution])
sub_regulonAUC <- sub_regulonAUC[onlyNonDuplicatedExtended(rownames(sub_regulonAUC)),] 
dim(sub_regulonAUC)
selectedResolution <- "celltype"
rss <- calcRSS(AUC = getAUC(sub_regulonAUC),
               cellAnnotation = CellTypes[colnames(sub_regulonAUC), selectedResolution])
rss <- na.omit(rss)
B_rss <- as.data.frame(rss)
colnames(B_rss) <- gsub(" ", "_", colnames(B_rss))
group <- c("CD4_Tem_0", "CD4_Tem_1")
rssRanklist <- list()

for (i in 1:length(group)) { # nolint
  data_rank_plot <- cbind(as.data.frame(rownames(B_rss)),
                          as.data.frame(B_rss[,group[i]]))
  colnames(data_rank_plot) <- c("TF", "group")
  data_rank_plot <- na.omit(data_rank_plot)
  data_rank_plot <- data_rank_plot[order(data_rank_plot$group, decreasing = TRUE),]
  data_rank_plot_top10 <- data_rank_plot[1:10, ]
  data_rank_plot_top10$rank <- seq(1, 10)
  # plot Figure 4K
  p <- ggplot(data_rank_plot_top10, aes(x = rank, y = group)) +
    geom_point(size = 3, color = "#1F77B4") +
    theme_bw() +
    theme(axis.title = element_text(colour = "black", size = 12),
          axis.text = element_text(colour = "black", size = 10),
          axis.text.x = element_blank(),
          axis.ticks.x = element_blank()) +
    labs(x = "Regulons Rank", y = "Specificity Score", title = group[i]) +
    geom_text_repel(aes(label = TF), color = "black", size = 3,
                    fontface = "italic", arrow = arrow(ends = "first", length = unit(0.01, "npc")),
                    box.padding = 0.2, point.padding = 0.3, segment.color = "black",
                    segment.size = 0.3, force = 1, max.iter = 3e3)
  rssRanklist[[i]] <- p
}

combined_plot <- plot_grid(rssRanklist[[1]], rssRanklist[[2]], 
                           nrow = 1,
                           align = "h",
                           axis = "tb",
                           rel_widths = c(1, 1))
combined_plot
ggsave("/data/Figure/F4K_CD4_Tem_ALL_RSS_top10.pdf", combined_plot, 
       width = 6,
       height = 6,
       device = "pdf")

loom$close()
